name: Test Individual

on:
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Which test to run'
        required: true
        default: 'minimal-spoiler'
        type: choice
        options:
          - minimal-spoiler
          - full-spoiler
          - minimal-spoiler-retest
          - full-spoiler-retest
          - multiplayer
          - multiworld
          - multitemplate-minimal
          - multitemplate-full

jobs:
  individual-test:
    name: Individual Test - ${{ github.event.inputs.test_type }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '~3.12.7'
          check-latest: true

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt -y install python3-gi libgirepository1.0-dev

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python ModuleUpdate.py --yes

      - name: Generate template files
        run: |
          source .venv/bin/activate
          python -c "from Options import generate_yaml_templates; generate_yaml_templates('Players/Templates')"

      - name: Generate multitemplate configurations
        if: github.event.inputs.test_type == 'multitemplate-minimal' || github.event.inputs.test_type == 'multitemplate-full'
        run: |
          source .venv/bin/activate
          python scripts/build/generate-multitemplate-configs.py

      - name: Configure host settings
        run: |
          source .venv/bin/activate
          python Launcher.py --update_settings
          if [[ "${{ github.event.inputs.test_type }}" == "full-spoiler" ]] || [[ "${{ github.event.inputs.test_type }}" == "full-spoiler-retest" ]] || [[ "${{ github.event.inputs.test_type }}" == "multitemplate-full" ]]; then
            python scripts/setup/update_host_settings.py full-spoilers
          else
            python scripts/setup/update_host_settings.py minimal-spoilers
          fi

      - name: Install Node.js dependencies
        run: npm install

      - name: Install Playwright browsers
        run: |
          source .venv/bin/activate
          npx playwright install chromium

      - name: Start HTTP server
        run: |
          python -m http.server 8000 &
          sleep 2

      - name: Run test
        run: |
          source .venv/bin/activate
          case "${{ github.event.inputs.test_type }}" in
            "minimal-spoiler")
              python scripts/test/test-all-templates.py -p
              ;;
            "full-spoiler")
              python scripts/test/test-all-templates.py -p
              ;;
            "minimal-spoiler-retest")
              python scripts/test/test-all-templates.py --minimal-spoilers --retest --retest-continue 10 -p
              ;;
            "full-spoiler-retest")
              python scripts/test/test-all-templates.py --full-spoilers --retest --retest-continue 10 -p
              ;;
            "multiplayer")
              python scripts/test/test-all-templates.py --multiplayer -p
              ;;
            "multiworld")
              python scripts/test/test-all-templates.py --multiworld -p
              ;;
            "multitemplate-minimal")
              python scripts/test/test-all-templates.py --templates-dir Players/presets/multitemplate/alttp --multitemplate -p
              ;;
            "multitemplate-full")
              python scripts/test/test-all-templates.py --templates-dir Players/presets/multitemplate/alttp --multitemplate -p
              ;;
          esac

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: individual-test-${{ github.event.inputs.test_type }}
          path: |
            scripts/output/${{
              github.event.inputs.test_type == 'minimal-spoiler' && 'spoiler-minimal/' ||
              github.event.inputs.test_type == 'minimal-spoiler-retest' && 'spoiler-minimal/' ||
              github.event.inputs.test_type == 'full-spoiler' && 'spoiler-full/' ||
              github.event.inputs.test_type == 'full-spoiler-retest' && 'spoiler-full/' ||
              github.event.inputs.test_type == 'multiplayer' && 'multiplayer/' ||
              github.event.inputs.test_type == 'multiworld' && 'multiworld/' ||
              github.event.inputs.test_type == 'multitemplate-minimal' && 'multitemplate-minimal/' ||
              'multitemplate-full/'
            }}
            docs/json/developer/test-results/
          retention-days: 7

      - name: Check for test failures
        if: always()
        run: |
          source .venv/bin/activate
          # Parse results and fail if tests failed
          python -c "
          import json
          import sys
          from pathlib import Path

          failed = False

          # Find all test results files
          for results_file in Path('scripts/output').rglob('test-results.json'):
              if results_file.stat().st_size > 0:
                  with open(results_file) as f:
                      data = json.load(f)
                      results = data.get('results', {})

                      for template, result in results.items():
                          if isinstance(result, dict):
                              # Check spoiler test (only if it exists)
                              if 'spoiler_test' in result:
                                  if result['spoiler_test'].get('pass_fail') == 'failed':
                                      print(f'❌ {template} failed spoiler test')
                                      failed = True

                              # Check multiplayer test (only if it exists)
                              if 'multiplayer_test' in result:
                                  if not result['multiplayer_test'].get('success', False):
                                      print(f'❌ {template} failed multiplayer test')
                                      failed = True

                              # Check multiworld test (only if it exists)
                              if 'multiworld_test' in result:
                                  if not result['multiworld_test'].get('success', False):
                                      print(f'❌ {template} failed multiworld test')
                                      failed = True

                              # Check generation (always check this)
                              if not result.get('generation', {}).get('success', False):
                                  print(f'❌ {template} failed generation')
                                  failed = True

          if failed:
              print('\\n❌ Some tests failed')
              sys.exit(1)
          else:
              print('✅ All tests passed!')
          "

  # Commit results job - runs after test completes
  commit-results:
    name: Commit Test Results
    runs-on: ubuntu-latest
    needs: individual-test
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: individual-test-${{ github.event.inputs.test_type }}
          path: artifacts

      - name: Merge test results into repository
        run: |
          # Create temporary directories
          mkdir -p /tmp/merged-results/scripts/output/spoiler-minimal
          mkdir -p /tmp/merged-results/scripts/output/spoiler-full
          mkdir -p /tmp/merged-results/scripts/output/multiplayer
          mkdir -p /tmp/merged-results/scripts/output/multiworld
          mkdir -p /tmp/merged-results/scripts/output/multitemplate-minimal
          mkdir -p /tmp/merged-results/scripts/output/multitemplate-full
          mkdir -p /tmp/merged-results/docs/json/developer/test-results

          # Copy JSON results to temp based on test type
          case "${{ github.event.inputs.test_type }}" in
            "minimal-spoiler"|"minimal-spoiler-retest")
              if [ -f artifacts/scripts/output/spoiler-minimal/test-results.json ]; then
                cp artifacts/scripts/output/spoiler-minimal/test-results.json /tmp/merged-results/scripts/output/spoiler-minimal/test-results.json
              fi
              ;;
            "full-spoiler"|"full-spoiler-retest")
              if [ -f artifacts/scripts/output/spoiler-full/test-results.json ]; then
                cp artifacts/scripts/output/spoiler-full/test-results.json /tmp/merged-results/scripts/output/spoiler-full/test-results.json
              fi
              ;;
            "multiplayer")
              if [ -f artifacts/scripts/output/multiplayer/test-results.json ]; then
                cp artifacts/scripts/output/multiplayer/test-results.json /tmp/merged-results/scripts/output/multiplayer/test-results.json
              fi
              ;;
            "multiworld")
              if [ -f artifacts/scripts/output/multiworld/test-results.json ]; then
                cp artifacts/scripts/output/multiworld/test-results.json /tmp/merged-results/scripts/output/multiworld/test-results.json
              fi
              ;;
            "multitemplate-minimal")
              if [ -f artifacts/scripts/output/multitemplate-minimal/test-results.json ]; then
                cp artifacts/scripts/output/multitemplate-minimal/test-results.json /tmp/merged-results/scripts/output/multitemplate-minimal/test-results.json
              fi
              ;;
            "multitemplate-full")
              if [ -f artifacts/scripts/output/multitemplate-full/test-results.json ]; then
                cp artifacts/scripts/output/multitemplate-full/test-results.json /tmp/merged-results/scripts/output/multitemplate-full/test-results.json
              fi
              ;;
          esac

          # Copy markdown documentation files to temp
          find artifacts -path "*/docs/json/developer/test-results/*.md" -exec cp {} /tmp/merged-results/docs/json/developer/test-results/ \;

          # List what was copied
          echo "=== Copied JSON Results to temp ==="
          ls -lh /tmp/merged-results/scripts/output/*/test-results.json || echo "No JSON files found"

          echo "=== Copied Markdown Files to temp ==="
          ls -lh /tmp/merged-results/docs/json/developer/test-results/*.md || echo "No markdown files found"

      - name: Create or switch to test-results-update branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all branches
          git fetch origin

          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin test-results-update; then
            echo "Branch test-results-update exists, checking it out"
            git checkout test-results-update
            git pull origin test-results-update
          else
            echo "Creating new branch test-results-update"
            git checkout -b test-results-update
          fi

          # Now copy the merged results from temp location
          echo "Copying merged results to repository..."
          mkdir -p scripts/output
          mkdir -p docs/json/developer/test-results

          cp -r /tmp/merged-results/scripts/output/* scripts/output/ 2>/dev/null || true
          cp /tmp/merged-results/docs/json/developer/test-results/*.md docs/json/developer/test-results/ 2>/dev/null || true

          echo "=== Files in repository after copy ==="
          ls -lh scripts/output/*/test-results.json || echo "No JSON files"
          ls -lh docs/json/developer/test-results/*.md || echo "No MD files"

      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add the specific files we want to commit
          git add scripts/output/spoiler-minimal/test-results.json || true
          git add scripts/output/spoiler-full/test-results.json || true
          git add scripts/output/multiplayer/test-results.json || true
          git add scripts/output/multiworld/test-results.json || true
          git add scripts/output/multitemplate-minimal/test-results.json || true
          git add scripts/output/multitemplate-full/test-results.json || true
          git add docs/json/developer/test-results/*.md || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ${{ github.event.inputs.test_type }} test results from GitHub Actions

            Generated by workflow run: ${{ github.run_id }}
            Triggered by: ${{ github.actor }}

            Test type: ${{ github.event.inputs.test_type }}
            All templates tested with seed 1 only
            Documentation generated with -p flag
            "

            git push origin test-results-update

            echo "✅ Test results committed to test-results-update branch"
            echo "View the branch at: ${{ github.server_url }}/${{ github.repository }}/tree/test-results-update"
          fi
